scenario: code-audit-demo
agent_mode: llm
tools_enabled:
  - read_file
  - search_knowledge_base
  - python_repl
coordination_pattern: planner_executor_verifier
max_cycles: 1
memory_limit: 10
max_steps: 4
stop_signals: ["done", "DONE"]
# graph_template: "mypkg.graphs:code_audit_flow"  # Optional custom LangGraph builder
# max_elapsed_sec: 20
shared_context:
  target: "src/app.py"
initial_instructions:
  - "审计 src/app.py，识别潜在安全问题（注入、路径遍历、弱鉴权等），给出风险级别和修复建议。"
files:
  src/app.py: |
    from flask import Flask, request, jsonify

    app = Flask(__name__)

    SECRET_TOKEN = "hardcoded-token"


    @app.route("/api/echo", methods=["POST"])
    def echo():
        data = request.json or {}
        # Potential injection point: eval on user input
        if "op" in data:
            try:
                result = eval(data["op"])
            except Exception as exc:
                result = f"error: {exc}"
        else:
            result = data
        return jsonify({"ok": True, "result": result})


    @app.route("/api/file")
    def file():
        # Potential path traversal: unvalidated path param
        path = request.args.get("path", "app.py")
        try:
            with open(path, "r") as f:
                content = f.read()
        except FileNotFoundError:
            content = "not found"
        return jsonify({"path": path, "content": content})


    @app.route("/api/secret")
    def secret():
        token = request.args.get("token")
        if token != SECRET_TOKEN:
            return jsonify({"error": "unauthorized"}), 403
        return jsonify({"secret": "top-secret-config"})


    if __name__ == "__main__":
        app.run(debug=True)
  notes.md: |
    - 关注 hardcoded 密钥、输入验证、调试模式、异常处理。
    - 建议输出：问题列表（描述/风险/利用面）、修复建议（简洁可执行）。
agents:
  - name: planner
    mode: llm
    system_prompt: "规划代码审计步骤，不调用工具，输出编号计划。"
    tools_allowed: []
  - name: executor
    mode: llm
    system_prompt: "执行代码审计，使用 read_file 检视代码，必要时用 python_repl 复现/验证。输出风险列表与修复建议。"
    tools_allowed: [read_file, python_repl, search_knowledge_base]
    blackboard_write_keys: ["findings"]
  - name: verifier
    mode: rule
    system_prompt: "检查执行结果是否覆盖注入、路径遍历、硬编码凭证、调试模式风险。满足则回复 DONE。"
    tools_allowed: []
